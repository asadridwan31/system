# Что изменилось

- больше не нужен атрибут `[Plugin]`, достаточно унаследоваться от базового класса
- порядок инициализации
  - конструкторы всех плагинов,
  - конструктор контекста (получает коллекцию плагинов)
  - плагинам дается экземпляр контекста, логгер, конфиг
  - инициализация плагинов (считать, что все остальные не инициализированы)
  - запуск плагинов (считать, что все остальные инициализированы)
    ...
  - остановка плагинов
- CORE
  - события - синхронные/асинхронные (определяет плагин) `SafeInvoke`
  - `SafeInvoke` может выполнить отдельный обработчик и коллекцию обработчиков
  - методы для поиска обработчиков событий и Registry для работы с группами обработчиков
  - изменилось API Context: `Context.Require`, `GetAllPlugins<T>`
  - API для работы с конфигами: Microsoft.Extensions.Configuration (хелперы: Microsoft.Extensions.Configuration.Binder)
  - конфиг перенесен в свойство плагина
  - настройки плагинов в разделе "plugins:<полное название класса плагина>"
  - `FindMethods` метод расширения базового класса плагина для поиска методов, отмеченных атрибутом
  - `FindAttrs` метод расширения базового класса плагина для поиска атрибутов плагинов
  - NLog => Microsoft.Extensions.Logging + Serilog
  - MEF => Microsoft.Extensions.DependencyInjection, не нужна ссылка в каждой DLL
  -
- Database
  - теперь в виде плагина,
  - работает на EF
  - не нужно делать все поля виртуальными,
  - конфигурация через атрибут [DbModelBuilder],
  - инициализируется на PluginInit
  - для миграций портирован ECM7.Migrator
- Таймеры
  - регистрация через атрибуты, можно указать любой интервал
WEB SERVER
  - Listener => WebServer
  - веб-сервер - теперь Kestrel, используется часть инфраструктуры ASP.NET Core MVC
  - порт веб-сервера в настройке `port`
  - асинхронная обработка запросов
  - базовые атрибуты для статических и динамических ресурсов
  - атрибуты для текстовых и бинарных динамических ресурсов, атрибут WebApiMethod
  - правила формирования URL
- Сценарии
  - JScript => V8 (jint)
  - из скриптов можно возвращать данные (написать return ...)
  - runScript => host.scripts.scriptName(args)
  - executeMethod => host.api.methodName(args)
  - logInfo, logError => host.log.trace/debug/info/warn/error/fatal
  - EmitScriptEvent для генерации сценарных событий
  - emit для генерации сценарных событий из других сценариев
  - обработчики сценарных событий запускаются асинхронно
  - изменены параметры http api сценариев
  - сценарные плагины (core, http api) в отдельных пакетах
  - Buffer - представление бинарных данных в сценариях
  - Сжатие ответа с помощью gzip
- WEB UI
  - marionette v3
  - bootstrap beta
  - requirejs => systemjs (поддержка форматов модулей)
  - полифилл для промисов, совместимы с $
  - кэширование ресурсов (во время разработки отключать кэш в браузере)
  - параметр alias для js ресурсов
  - получение конфига приложения с сервера
  - заглушка стартовой страницы (модуль 'welcome' + настройка мэппинга в конфиге)
  - загрузчик шаблонов применяется автоматом для `.tpl`, то же самое с `.json`
  - больше не используется JSON2
  - списки разделов (и соответствующие атрибуты) в отдельном пакете
  - иконки для разделов (fa)
  - автозагрузка стилей без js (генерация файла с импортами)
  - отображение ошибки загрузки разделов
  - `lib.ajax.loadModel(url, [data], [Model])`
  - `lib.ajax.getJSON(url, [data])`
  - `lib.ajax.postJSON(url, [data])`
  - обработка асинхронных исключений в метода start (нужно вернуть промис из него)
  - локализация: вместо статических классов свойство `StringLocalizer` у плагина
  - `[HttpLocalizationResource("/static/tmp/lang.json")]` - на клиент приходят переводы текущего плагина в json
  - клиентская локализация: было `templateHelpers: { lang: lang }`, стало `templateContext: { lang: lang }`
  - локализация: название раздела web UI берется из ресурсов текущего плагина
  - бандлы для шаблонов: `[TemplateResource]`
  - ~~загрузчик для шаблонов handlebars~~ если сделать загрузчик, он не использует бандл с шаблонами

- mail plugin: `sendMail` + `host.api.sendMail`, `host.api.sendMailWithAttachment`
- MQTT плагин:
  - можно подписаться на несколько топиков
  - не сохраняет сообщения в БД, только генерирует события
  - сценарное событие получает buffer, а не только id, как раньше
  - методы для отправки массива байтов и строки
  - в сценариях можно отправлять сообщения MQTT
- nooLite: поддерживается только MTRF-64-USB


- Теперь по умолчанию приложение ожидает Ctrl+C для остановки. Чтобы останавливалось по нажатию ENTER, нужно передать при запуске параметр -enter.
- общий файл с версией пакета
- scheduler => cron, можно задавать маски + условия по номеру дня и месяца + нет будильника + добавлено событие для плагинов


## Правила
- должен быть README
- При добавлении сущностей выпускаем новую минорную версию плагина, при изменении/удалении сущностей - мажорную версию
- При выпуске мажорной версии плагина нужно слить миграции последней мажорной версии в одну (с последним номером)??

## README

[ПРИМЕР](https://gist.github.com/dima117/a59ec07b732bfe6a99d3c89fa87aeb71)

## URLS

### Методы API

`/api/{pluginAlias}/{methodAlias}`

`/api/{pluginAlias}/{entityALias}/{methodAlias}`

### Статические файлы

`/static/{pluginAlias}/{filePath}`

### Библиотеки от сторонних разработчиков

Суффикс `.min` в url не указываем.

`/vendor/js/{filePath}`
`/vendor/css/{filePath}`
`/vendor/fonts/{filePath}`

### Ядро веб-приложения

`/webapp/{filePath}`

## Deployment

http://www.diericx.net/post/building-windows-linux-and-osx-dotnet-core-binaries/
